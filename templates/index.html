<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Review Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .step-content {
            display: none;
        }

        .step-content.open {
            display: block;
        }

        /* Custom scrollbar for sidebar */
        .sidebar-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .sidebar-scroll::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* JSON Renderer Styles */
        .json-key {
            color: #4b5563;
            font-weight: 600;
        }

        .json-string {
            color: #059669;
        }

        .json-number {
            color: #d97706;
        }

        .json-boolean {
            color: #7c3aed;
        }

        .json-null {
            color: #9ca3af;
        }

        .json-block {
            margin-left: 1.5rem;
            border-left: 2px solid #e5e7eb;
            padding-left: 0.5rem;
            margin-top: 0.25rem;
            margin-bottom: 0.25rem;
        }
    </style>
</head>

<body class="bg-gray-100 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <div class="w-64 bg-white shadow-lg flex flex-col h-full">
        <div class="p-4 border-b">
            <h1 class="text-xl font-bold text-gray-800">Agentic AI Code Review</h1>
        </div>

        <div class="p-4 border-b">
            <form id="reviewForm" class="space-y-3">
                <div>
                    <label for="prUrl" class="block text-xs font-medium text-gray-700">Github PR URL</label>
                    <input type="text" id="prUrl" name="prUrl" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-xs p-2 border"
                        placeholder="https://github.com/owner/repo/pull/123">
                </div>
                <div class="flex space-x-2">
                    <button type="button" id="fetchHistoryBtn"
                        class="flex-1 justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Fetch History
                    </button>
                    <button type="submit"
                        class="flex-1 justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Trigger Review
                    </button>
                </div>
            </form>
        </div>

        <div class="flex-1 overflow-y-auto sidebar-scroll p-4">
            <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">History</h2>
            <div id="runsList" class="space-y-2">
                <!-- Runs will be listed here -->
                <div class="text-xs text-gray-400 text-center italic">No runs found</div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col h-full overflow-hidden">
        <header class="bg-white shadow-sm p-4 flex justify-between items-center z-10">
            <h2 id="currentRunTitle" class="text-lg font-medium text-gray-900">Select a run or trigger a new one</h2>
            <div class="flex items-center space-x-3">
                <button id="refreshBtn" onclick="refreshCurrentRun()"
                    class="hidden px-3 py-1 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Refresh
                </button>
                <span id="connectionStatus"
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                    Disconnected
                </span>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6 space-y-6" id="mainContent">
            <!-- Plan Section -->
            <!-- Summary Section -->
            <div id="summaryContainer" class="hidden mb-8">
                <div class="bg-white rounded-lg shadow border-l-4 border-purple-500 overflow-hidden">
                    <div class="p-4 border-b border-gray-100">
                        <h3 class="text-lg font-semibold text-purple-700" id="summaryHeader">Executive Summary</h3>
                    </div>
                    <div id="summaryContent" class="p-6 prose prose-sm max-w-none text-gray-700 bg-gray-50">
                        <!-- Summary will be injected here -->
                    </div>
                </div>
            </div>

            <!-- Files Container -->
            <div id="filesContainer" class="space-y-8">
                <!-- File reviews will be appended here -->
            </div>

            <!-- Debug Log -->
            <div class="mt-8 p-4 bg-gray-800 text-green-400 rounded text-xs font-mono hidden" id="debugLog">
                <h3 class="font-bold border-b border-gray-700 mb-2">Debug Log</h3>
                <div id="debugContent" class="h-32 overflow-y-auto"></div>
            </div>
        </main>
    </div>

    <script>
        const form = document.getElementById('reviewForm');
        const runsList = document.getElementById('runsList');
        const filesContainer = document.getElementById('filesContainer');
        const currentRunTitle = document.getElementById('currentRunTitle');
        const connectionStatus = document.getElementById('connectionStatus');

        let eventSource = null;
        let currentRepo = '';
        let currentPr = '';

        // Load runs on input blur or submit
        async function loadRuns(repoUrl, prNumber) {
            if (!repoUrl || !prNumber) return;

            const repoName = repoUrl.replace(/\/$/, '').split('/').pop();
            currentRepo = repoName;
            currentPr = prNumber;

            try {
                const response = await fetch(`/runs/${repoName}/${prNumber}`);
                const data = await response.json();
                renderRuns(data.runs);
            } catch (error) {
                console.error('Failed to load runs:', error);
            }
        }

        function renderRuns(runs) {
            runsList.innerHTML = '';
            if (runs.length === 0) {
                runsList.innerHTML = '<div class="text-xs text-gray-400 text-center italic">No runs found</div>';
                return;
            }

            runs.forEach(run => {
                const div = document.createElement('div');

                let timeHash, repoName, prNumber;

                if (typeof run === 'object') {
                    timeHash = run.time_hash;
                    repoName = run.repo_name;
                    prNumber = run.pr_number;
                } else {
                    timeHash = run;
                    repoName = currentRepo;
                    prNumber = currentPr;
                }

                // Format timestamp: YYYYMMDDHHMMSS -> Local Date Time
                const year = timeHash.substring(0, 4);
                const month = timeHash.substring(4, 6);
                const day = timeHash.substring(6, 8);
                const hour = timeHash.substring(8, 10);
                const minute = timeHash.substring(10, 12);
                const second = timeHash.substring(12, 14);
                const date = new Date(year, month - 1, day, hour, minute, second);

                div.className = 'p-3 bg-white rounded border border-gray-200 hover:border-indigo-500 cursor-pointer transition-colors shadow-sm';

                let content = `<div class="text-sm font-medium text-gray-900">Run ${timeHash}</div>`;
                if (typeof run === 'object') {
                    content += `<div class="text-xs text-indigo-600 font-semibold mb-1">${repoName} #${prNumber}</div>`;
                }
                content += `<div class="text-xs text-gray-500">${date.toLocaleString()}</div>`;

                div.innerHTML = content;
                div.onclick = () => {
                    // Update context if switching runs
                    if (repoName && prNumber) {
                        currentRepo = repoName;
                        currentPr = prNumber;
                        // Only update input if we have a valid URL structure, otherwise keep it or clear it?
                        // Since we don't have the full owner/repo from the run history (only repo name),
                        // we can't reconstruct the full URL accurately.
                        // Better to NOT update the input with a broken URL.
                        // Or try to use the saved one if it matches.

                        const savedPrUrl = localStorage.getItem('lastPrUrl');
                        if (savedPrUrl && savedPrUrl.includes(repoName) && savedPrUrl.includes(prNumber)) {
                            document.getElementById('prUrl').value = savedPrUrl;
                        } else {
                            // If we can't reconstruct it, maybe just show a placeholder or don't touch it
                            // document.getElementById('prUrl').value = `https://github.com/.../${repoName}/pull/${prNumber}`;
                        }
                    }
                    loadRun(timeHash);
                };
                runsList.appendChild(div);
            });
        }

        function loadRun(timeHash) {
            log(`Loading run: ${timeHash}`);
            currentRunHash = timeHash;
            document.getElementById('refreshBtn').classList.remove('hidden');

            // Update UI
            currentRunTitle.textContent = `Viewing Run: ${timeHash} for Task: Code Review of PR ${currentRepo} #${currentPr}`;

            // Clear previous content
            filesContainer.innerHTML = '';
            document.getElementById('summaryContainer').classList.add('hidden');
            document.getElementById('summaryContent').innerHTML = '';

            // Close existing stream
            if (eventSource) {
                eventSource.close();
            }

            // Start new stream
            const streamUrl = `/stream/${currentRepo}/${currentPr}/${timeHash}`;
            log(`Connecting to stream: ${streamUrl}`);
            connectStream(streamUrl);
        }

        function connectStream(url) {
            connectionStatus.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
            connectionStatus.textContent = 'Connecting...';

            eventSource = new EventSource(url);

            eventSource.onopen = () => {
                log('Stream connected');
                connectionStatus.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                connectionStatus.textContent = 'Live';
            };

            eventSource.onmessage = (event) => {
                // log(`Received event: ${event.data.substring(0, 50)}...`);
                try {
                    const data = JSON.parse(event.data);
                    renderEvent(data);
                } catch (e) {
                    log(`Error parsing event: ${e}`);
                }
            };

            eventSource.onerror = (error) => {
                log('Stream error');
                console.error('EventSource failed:', error);
                connectionStatus.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800';
                connectionStatus.textContent = 'Disconnected';
                // eventSource.close(); // Don't close immediately, it might reconnect
            };
        }

        function renderEvent(data) {
            const type = data.type;
            const filePath = data.file_path;

            log(`Rendering event: ${type} for ${filePath}`);

            if (!filePath) {
                log('Missing filePath, skipping');
                return;
            }

            let content = {};
            try {
                content = JSON.parse(data.content || '{}');
            } catch (e) {
                content = { raw: data.content };
            }

            // Get or create file section (skip for summary)
            let fileSection = null;
            if (type !== 'summary') {
                fileSection = document.getElementById(`file-${btoa(filePath)}`);
                if (!fileSection) {
                    log(`Creating new section for ${filePath}`);
                    fileSection = createFileSection(filePath);
                    filesContainer.appendChild(fileSection);
                }
            }

            const planContent = fileSection ? fileSection.querySelector('.plan-content') : null;
            const planSection = fileSection ? fileSection.querySelector('.plan-section') : null;
            const stepsSection = fileSection ? fileSection.querySelector('.steps-section') : null;

            if (type === 'plan') {
                planSection.classList.remove('hidden');
                planContent.innerHTML = renderContent(content);

                // Update header with timestamp if available (optional, or just keep static)
                // const header = fileSection.querySelector('.plan-header-text');
                // header.textContent = `Review Plan for ${filePath}`;

            } else if (type === 'step') {
                const stepName = data.step_name;
                const stepId = `step-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

                const div = document.createElement('div');
                div.className = 'bg-white rounded-lg shadow border-l-4 border-green-500 overflow-hidden';
                div.innerHTML = `
                    <div class="p-4 flex justify-between items-center cursor-pointer hover:bg-gray-50 transition-colors" onclick="toggleStep('${stepId}')">
                        <div class="flex items-center space-x-3">
                            <span class="flex-shrink-0 h-6 w-6 rounded-full bg-green-100 flex items-center justify-center text-green-600">✓</span>
                            <div>
                                <h3 class="text-md font-medium text-gray-900">${stepName}</h3>
                            </div>
                        </div>
                        <span class="text-gray-400 transform transition-transform duration-200" id="icon-${stepId}">▼</span>
                    </div>
                    <div id="${stepId}" class="step-content border-t border-gray-100 bg-gray-50">
                        <div class="p-4 text-sm font-mono text-gray-700 overflow-x-auto">
                            ${renderContent(content)}
                        </div>
                    </div>
                `;
                stepsSection.appendChild(div);
            } else if (type === 'summary') {
                const summaryContainer = document.getElementById('summaryContainer');
                const summaryContent = document.getElementById('summaryContent');
                const summaryHeader = document.getElementById('summaryHeader');

                summaryContainer.classList.remove('hidden');

                // Update header with full URL if available
                if (data.repo_url && data.pr_number) {
                    const repoUrl = data.repo_url.replace(/\/$/, ""); // Remove trailing slash
                    const prUrl = `${repoUrl}/pull/${data.pr_number}`;
                    summaryHeader.innerHTML = `Executive Summary of <a href="${prUrl}" target="_blank" class="underline hover:text-purple-900">PR #${data.pr_number}</a>`;
                } else {
                    summaryHeader.textContent = "Executive Summary";
                }

                // Simple markdown rendering (bold, headers, lists)
                let html = data.content
                    .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold mb-4">$1</h1>')
                    .replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold mb-3 mt-4">$1</h2>')
                    .replace(/^### (.*$)/gim, '<h3 class="text-lg font-bold mb-2 mt-3">$1</h3>')
                    .replace(/\*\*(.*)\*\*/gim, '<b>$1</b>')
                    .replace(/^\- (.*$)/gim, '<li class="ml-4">$1</li>')
                    .replace(/\n/gim, '<br>');

                summaryContent.innerHTML = html;
            }
        }

        function createFileSection(filePath) {
            const safeId = btoa(filePath);
            const div = document.createElement('div');
            div.id = `file-${safeId}`;
            div.className = 'space-y-4';

            div.innerHTML = `
                <div class="flex items-center space-x-2 mb-4">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h2 class="text-xl font-bold text-gray-800">Review Plan for File: ${filePath}</h2>
                </div>

                <div class="plan-section hidden">
                    <div class="bg-white rounded-lg shadow border-l-4 border-blue-500 overflow-hidden">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center cursor-pointer hover:bg-gray-50 transition-colors"
                            onclick="togglePlan('${safeId}')">
                            <h3 class="plan-header-text text-lg font-semibold text-blue-700">Review Plan</h3>
                            <span class="text-gray-400 transform transition-transform duration-200" id="planIcon-${safeId}">▼</span>
                        </div>
                        <div id="planBody-${safeId}" class="p-4 transition-all duration-200">
                            <pre class="plan-content bg-gray-50 p-4 rounded text-sm overflow-x-auto font-mono text-gray-700 mb-6"></pre>

                            <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wider">Execution Steps</h4>
                            <div class="steps-section space-y-4">
                                <!-- Steps will be appended here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            return div;
        }

        function renderContent(data) {
            if (typeof data === 'object' && data !== null) {
                if (Array.isArray(data)) {
                    if (data.length === 0) return '<span class="text-gray-400">[]</span>';
                    let html = '<div class="json-block">';
                    data.forEach(item => {
                        html += `<div>${renderContent(item)}</div>`;
                    });
                    html += '</div>';
                    return html;
                } else {
                    if (Object.keys(data).length === 0) return '<span class="text-gray-400">{}</span>';
                    let html = '<div class="json-block">';
                    for (const [key, value] of Object.entries(data)) {
                        html += `<div class="mb-1"><span class="json-key">${key}:</span> ${renderContent(value)}</div>`;
                    }
                    html += '</div>';
                    return html;
                }
            } else if (typeof data === 'string') {
                // Check if it looks like a code block or long text
                if (data.includes('\n') || data.length > 50) {
                    return `<div class="mt-1 p-2 bg-gray-100 rounded text-xs whitespace-pre-wrap border border-gray-200 text-gray-800">${escapeHtml(data)}</div>`;
                }
                return `<span class="json-string">"${escapeHtml(data)}"</span>`;
            } else if (typeof data === 'number') {
                return `<span class="json-number">${data}</span>`;
            } else if (typeof data === 'boolean') {
                return `<span class="json-boolean">${data}</span>`;
            } else if (data === null) {
                return `<span class="json-null">null</span>`;
            }
            return String(data);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function (m) { return map[m]; });
        }

        window.toggleStep = function (id) {
            const el = document.getElementById(id);
            const icon = document.getElementById(`icon-${id}`);
            el.classList.toggle('open');
            if (el.classList.contains('open')) {
                icon.style.transform = 'rotate(180deg)';
            } else {
                icon.style.transform = 'rotate(0deg)';
            }
        }

        window.togglePlan = function (id) {
            const el = document.getElementById(`planBody-${id}`);
            const icon = document.getElementById(`planIcon-${id}`);
            if (el.style.display === 'none') {
                el.style.display = 'block';
                icon.style.transform = 'rotate(0deg)';
            } else {
                el.style.display = 'none';
                icon.style.transform = 'rotate(-90deg)';
            }
        }

        function parsePrUrl(url) {
            try {
                // Expected format: https://github.com/owner/repo/pull/123
                const regex = /github\.com\/([^\/]+\/[^\/]+)\/pull\/(\d+)/;
                const match = url.match(regex);
                if (match) {
                    return {
                        repoUrl: `https://github.com/${match[1]}`,
                        prNumber: match[2]
                    };
                }
            } catch (e) {
                console.error("Error parsing URL", e);
            }
            return null;
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const prUrl = document.getElementById('prUrl').value;
            const parsed = parsePrUrl(prUrl);

            if (!parsed) {
                alert('Invalid GitHub PR URL. Expected format: https://github.com/owner/repo/pull/123');
                return;
            }

            const { repoUrl, prNumber } = parsed;

            // Save to localStorage
            localStorage.setItem('lastPrUrl', prUrl);

            // Refresh runs list just in case
            await loadRuns(repoUrl, prNumber);

            try {
                const response = await fetch('/review', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ repo_url: repoUrl, pr_number: parseInt(prNumber) }),
                });

                const data = await response.json();

                // Refresh runs list to show the new one
                await loadRuns(repoUrl, prNumber);

                // Automatically select the new run
                loadRun(data.time_hash);

            } catch (error) {
                console.error('Error:', error);
                alert('Failed to trigger review');
            }
        });

        // Helper to fetch all runs
        async function fetchAllRuns() {
            try {
                const response = await fetch('/runs');
                const data = await response.json();
                renderRuns(data.runs);
            } catch (error) {
                console.error('Failed to load all runs:', error);
            }
        }

        document.getElementById('fetchHistoryBtn').addEventListener('click', fetchAllRuns);

        // Load saved values on startup
        window.addEventListener('DOMContentLoaded', () => {
            const savedPrUrl = localStorage.getItem('lastPrUrl');
            const prUrlInput = document.getElementById('prUrl');

            if (savedPrUrl) {
                prUrlInput.value = savedPrUrl;
            }

            // Always fetch all runs on startup
            fetchAllRuns();
        });

        let currentRunHash = '';

        function refreshCurrentRun() {
            if (currentRunHash) {
                loadRun(currentRunHash);
            }
        }

        // ... (rest of script) ...
        function log(msg) {
            const debugLog = document.getElementById('debugLog');
            const debugContent = document.getElementById('debugContent');
            debugLog.classList.remove('hidden');
            const div = document.createElement('div');
            div.textContent = `${new Date().toISOString().split('T')[1]} - ${msg}`;
            debugContent.appendChild(div);
            debugContent.scrollTop = debugContent.scrollHeight;
        }
    </script>
</body>

</html>